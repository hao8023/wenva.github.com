---
layout: post
title: "外网主机连接内网主机"
date: 2016-05-30
comments: false
categories: 技巧
---

很早就有这样一个想法: 通过远程控制内网主机，原来有尝试借助于路由器的端口映射或DMZ来实现，可是后面发现这并不现实，首先是加入有多级路由，那每个路由都要配置，非常麻烦，而且有些跟路由，根本无法触及到;其次电信、联通等网络并不一定暴露公网IP给我们，因此外网根本访问不到（可以理解为我们处于一个大局域网下）；由于这种种原因，渐渐放弃了这个想法，直到有一天发现SSH反向连接这个东西. 当时一看到这个，就好像发现新大陆一样，无比兴奋，经过一段时间的折腾，终于找到了控制内网直接的好方案.

## 背景

* SSH正向连接

* SSH反向连接



[待整理](http://logan.tw/posts/2015/11/15/autossh-and-systemd-service/)

外部主机要想访问内网主机，

sudo vim /lib/systemd/system/autossh.service
<pre>
[Unit]
Description=autossh
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=用户名
EnvironmentFile=/etc/default/autossh
ExecStart=
ExecStart=/usr/bin/autossh $SSH_OPTIONS
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
</pre>

sudo ln -s /lib/systemd/system/autossh.service \
      /etc/systemd/system/autossh.service

sudo vim /etc/default/autossh

<pre>
AUTOSSH_POLL=60
AUTOSSH_FIRST_POLL=30
AUTOSSH_GATETIME=0
AUTOSSH_PORT=22000
SSH_OPTIONS="-N -R 2222:localhost:22 example.com -i /home/autossh/.ssh/id_rsa"
</pre>

<pre>
sudo systemctl daemon-reload
sudo systemctl start autossh
sudo systemctl status autossh
</pre>

<pre>
● autossh.service - autossh
   Loaded: loaded (/lib/systemd/system/autossh.service; enabled)
   Active: active (running) since Mon 2016-05-30 22:04:00 CST; 9s ago
 Main PID: 751 (autossh)
   CGroup: /system.slice/autossh.service
           ├─751 /usr/lib/autossh/autossh -N -R 10023:localhost:22 root@45.32.21.185 -i /home/osmc/.ssh/id_rsa
           └─754 /usr/bin/ssh -L 22000:127.0.0.1:22000 -R 22000:127.0.0.1:22001 -N -R 10023:localhost:22 -i /home/osmc/.ssh/id_rsa root@4...

May 30 22:04:01 smallmuou autossh[751]: starting ssh (count 1)
May 30 22:04:01 smallmuou autossh[751]: ssh child pid is 754
</pre>


端口转换

<pre>
ssh -fCNL *:20023:localhost:10023 localhost
</pre>