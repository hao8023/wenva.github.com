---
layout: post
title: "linphone资料整理"
date: 2015-02-02
comments: false
---
# linphone资料整理
February 2, 2015

## 依赖库
* libtool - 封装了不同平台动态链接库的差异，为开发人员提供统一接口
* bcg729 - g729语音编解码库
* belle-sip - SIP协议栈
* msamr - AMR即自适应多速率压缩（Adaptive multi-Rate compression）是一个使语音编码最优化的专利
* msilbc - iLBC是一种专为包交换网络通信设计的编解码，优于目前流行的G.729、G.723.1，对丢包进行了特有处理，即使在丢包率 相当高的网络环境下，仍可获得非常清晰的语音效果。
* msopenh264 - 思科的h264编解码器
* antlr3 - 语言识别的一个工具 (ANother Tool for Language Recognition ) 是一种语言工具，它提供了一个框架，可以通过包含 Java, C++, 或 C# 动作（action）的语法描述来构造语言识别器，编译器和解释器。
	* 安装方法:
	<pre>
	下载jar文件，并拷贝到/usr/share/java目录下
	sudo cp antlr-3.4-complete.jar /usr/share/java/antlr.jar
	</pre>
	** <font color=d80000>注意:必须是3.4，否则可能会报_empty不存在 </font> **


## Build 问题汇总
### 1. error: C compiler cannot create executables
##### 问题
<pre>
checking whether the C compiler works... no
configure: error: in `/Users/starnet/Projects/linphone-iphone/submodules/build-i386-apple-darwin/externals/polarssl':
configure: error: C compiler cannot create executables
</pre>
##### 分析
<pre>
clang -std=c99 -Qunused-arguments -Wno-unknown-warning-option -Wno-unused-command-line-argument-hard-error-in-future  -arch i386  -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk -mios-simulator-version-min=4.0 -DTARGET_OS_IPHONE=1 -D__IOS -fms-extensions -Dsha256=polarssl_sha256  -Dasm=__asm hello.c 
ld: -pie can only be used when targeting iOS 4.2 or later
clang: error: linker command failed with exit code 1 (use -v to see invocation)
</pre>
修改上述ios-simulator-version-min=4.2即可以通过编译

##### 处理
于是修改submodules/build/iphone-config.site的SDK_VERSION
<pre>
SDK_VERSION_MAJOR=4                                                              
SDK_VERSION=4.2   
</pre>

### 2. aclocal: error: aclocal: file 'm4/lt~obsolete.m4' does not exist
##### 问题
<pre>
-e  Running autogen for msopus in /Users/starnet/Projects/linphone-iphone/submodules/build/..//externals/opus 
cd /Users/starnet/Projects/linphone-iphone/submodules/build/..//externals/opus && ./autogen.sh
Updating build configuration files, please wait....
aclocal: error: aclocal: file 'm4/lt~obsolete.m4' does not exist
autoreconf: aclocal failed with exit status: 1
</pre>

##### 分析
分析发现/opt/local/share/aclocal/lt~obsolete.m4路径不存在，发现/usr/local/share/aclocal/存在，于是建立软连接
	
##### 处理
<pre>
sudo ln -s /usr/local/share/aclocal /opt/local/share/
</pre>

### 3. configure: error: GNU gettext tools not found; required for intltool
##### 问题
<pre>
configure: error: GNU gettext tools not found; required for intltool
</pre>
##### 分析
未安装gettext

##### 处理
<pre>
sudo brew install gettext
sudo ln -s /usr/local/Cellar/gettext/0.19.3_1/bin/msgmerge /usr/local/bin/
sudo ln -s /usr/local/Cellar/gettext/0.19.3_1/bin/msgfmt /usr/local/bin/
sudo ln -s /usr/local/Cellar/gettext/0.19.3_1/bin/xgettext /usr/local/bin/
</pre>
	
### 4. 'CoreFoundation/CFUserNotification.h' file not found
##### 问题
<pre>
In file included from /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/Frameworks/CFNetwork.framework/Headers/CFHost.h:22:
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/Frameworks/CoreFoundation.framework/Headers/CoreFoundation.h:92:10: fatal error: 
      'CoreFoundation/CFUserNotification.h' file not found
#include <CoreFoundation/CFUserNotification.h>
</pre>
	
##### 分析
查看CoreFoundation.h文件，发现TARGET_OS_IPHONE被重置为0，经过寻找是由于CFBase.h中调用的TargetConditionals.h是来自于MacOSX10.10的SDK下面，后面发现是由于指定了C_INCLUDE_PATH
<pre>
declare -x C_INCLUDE_PATH="/Developer//Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.10.sdk/usr/include/"
</pre>
##### 处理
直接export C_INCLUDE_PATH = ""
	
### 5. error: Libtool library used but 'LIBTOOL' is undefined
##### 问题
<pre>
CUnit/Sources/Automated/Makefile.am:3: error: Libtool library used but 'LIBTOOL' is undefined
CUnit/Sources/Automated/Makefile.am:3:   The usual way to define 'LIBTOOL' is to add 'LT_INIT'
CUnit/Sources/Automated/Makefile.am:3:   to 'configure.in' and run 'aclocal' and 'autoconf' again.
CUnit/Sources/Automated/Makefile.am:3:   If 'LT_INIT' is in 'configure.in', make sure
</pre>
##### 分析
aclocal是一个perl脚本程序，扫描configure.ac来创建aclocal.m4文件，以供autoconf来生成configure文件
'LIBTOOL' is undefined是由于aclocal找不到libtool宏，原因可能是没安装libtool或路径不对，aclocal -I可以制定m4文件路径
	
##### 处理
拷贝libtool下得m4文件到aclocal下
<pre>
sudo cp /usr/local/Cellar/libtool/2.4.2/share/aclocal/* /opt/local/share/aclocal/
</pre>

### 6. syntax error near unexpected token `am__api_version='1.14''

##### 问题
<pre>
/Users/starnet/Projects/linphone-iphone/submodules/build/..//belle-sip/configure: line 2637: syntax error near unexpected token \`am__api_version='1.14''
/Users/starnet/Projects/linphone-iphone/submodules/build/..//belle-sip/configure: line 2637: `am__api_version='1.14''
builders.d/belle-sip.mk:27: recipe for target '/Users/starnet/Projects/linphone-iphone/submodules/build/../build-i386-apple-darwin/belle-sip/Makefile' failed
make[1]: *** [/Users/starnet/Projects/linphone-iphone/submodules/build/../build-i386-apple-darwin/belle-sip/Makefile] Error 2
</pre>
	
##### 分析
测试发现是由于PKG_PROG_PKG_CONFIG() 未定义导致的，而PKG_PROG_PKG_CONFIG() 是存在于pkg.m4中（由pkg-config提供）
	
##### 处理
通过aclocal -I或者将pkg.m4拷贝到aclocal的目录下
<pre>
aclocal --print-ac-dir #可以查看aclocal目录
sudo cp /usr/local/Cellar/pkg-config/0.28/share/aclocal/pkg.m4 /opt/local/share/aclocal/
</pre>	

### 7. syntax error near unexpected token `MSGFMT,'
##### 问题
<pre>
/Users/starnet/Projects/linphone-iphone/submodules/build/..//linphone/mediastreamer2/configure: line 17534: syntax error near unexpected token `MSGFMT,'
/Users/starnet/Projects/linphone-iphone/submodules/build/..//linphone/mediastreamer2/configure: line 17534: `        AM_PATH_PROG_WITH_TEST(MSGFMT, msgfmt,'
configure: error: /Users/starnet/Projects/linphone-iphone/submodules/build/..//linphone/mediastreamer2/configure failed for mediastreamer2
builder-iphone-os.mk:173: recipe for target '/Users/starnet/Projects/linphone-iphone/submodules/build/../build-i386-apple-darwin/linphone/Makefile' failed
make[1]: *** [/Users/starnet/Projects/linphone-iphone/submodules/build/../build-i386-apple-darwin/linphone/Makefile] Error 2
</pre>

##### 分析
测试发现是AM_PATH_PROG_WITH_TEST未定义，这个是在gettext的m4文件中定义

##### 处理
拷贝m4到aclocal下
<pre>
sudo cp /usr/local/Cellar/gettext/0.19.3_1/share/aclocal/* /opt/local/share/aclocal
</pre>

### 8. ld: illegal text-relocation to '_vp8_dequant_idct_add_mmx'
##### 问题
<pre>
ld: illegal text-relocation to '_vp8_dequant_idct_add_mmx' in /Users/starnet/Projects/linphone-iphone/liblinphone-sdk/i386-apple-darwin/lib/libvpx.a(dequantize_mmx.asm.o) from '_vp8_dequant_idct_add_mmx' in /Users/starnet/Projects/linphone-iphone/liblinphone-sdk/i386-apple-darwin/lib/libvpx.a(dequantize_mmx.asm.o) for architecture i386
clang: error: linker command failed with exit code 1 (use -v to see invocation)
</pre>

##### 分析
[这里](http://stackoverflow.com/questions/6650178/illegal-text-reloc-to-non-lazy-ptr-error-while-building-in-xcode-4-with-libav-l)有关于illegal text-relocation的说明
大致意思：当一个全局变量被编译到动态库中，而第三方asm代码需要引用该变量时，连接器会把相对地址付给相应引用，当他们处于一个连接单元时，则不会有问题，当不同单元则就会出问题；应该是连接器的一个bug

##### 处理
编辑Makefile, 为LDFLAGS添加-read_only_relocs suppress
<pre>
 LDFLAGS = -read_only_relocs suppress 
</pre>

### 9. extract-cfile.awk无法下载
##### 问题
<pre>
/usr/local/bin/wget --no-check-certificate http://www.webrtc.org/ilbc-freeware/ilbc-source-code-and-utili/ilbc-utilities/extract-cfile.awk -O extract-cfile.awk
--2015-02-04 12:59:41--  http://www.webrtc.org/ilbc-freeware/ilbc-source-code-and-utili/ilbc-utilities/extract-cfile.awk
Resolving www.webrtc.org... 74.125.23.121
Connecting to www.webrtc.org|74.125.23.121|:80... 
</pre>
##### 分析
链接不存在
##### 处理
到www.ilbcfreeware.org下载extract-cfile.txt，拷贝到submodules/build-i386-apple-darwin/libilbc-rfc3951/downloads下，重命名成extract-cfile.awk

### 10. No working C compiler found.
##### 问题
<pre>
./configure --prefix=/Users/starnet/Projects/linphone-iphone/submodules/build/..//../liblinphone-sdk/i386-apple-darwin  --host=i386-apple-darwin --enable-static --enable-pic --cross-prefix=$SDK_BIN_PATH/ --extra-ldflags="$COMMON_FLAGS" --extra-cflags="$COMMON_FLAGS "
Loading config.site for iPhone platform=Simulator version=4.2
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator8.1.sdk
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk
Selecting SDK path = /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk
No working C compiler found.
</pre>
##### 分析
查看configure文件
<pre>
...
if $cc_cmd >conftest.log 2>&1; then                                          
...
</pre>
即结果导入conftest.log, 发现如下
<pre>
clang: error: unknown argument: '-falign-loops=16' 
</pre>
即clang不支持-falign-loops
##### 处理
编辑configure，去除-falign-loops
<pre>
457     darwin*)                                                                     
458         SYS="MACOSX"                                                             
459  #       CFLAGS="$CFLAGS -falign-loops=16"                                       
460         libm="-lm"         
</pre>

### 11. compile: unable to infer tagged configuration
##### 问题
<pre>
libtool: compile: unable to infer tagged configuration
libtool: compile: specify a tag with `--tag'
Makefile:1039: recipe for target 'backgroundtask.lo' failed
make[1]: *** [backgroundtask.lo] Error 1
</pre>

##### 分析
如果使用的compiler不是gcc, libtool会认错，需要添加参数--tag=CXX或--tag=CC

##### 处理
<pre>
LTOBJCCOMPILE = $(LIBTOOL) $(AM_V_lt) <font color="ff0000"> --tag=CC </font>$(AM_LIBTOOLFLAGS) \ 
...
OBJCLINK = $(LIBTOOL) $(AM_V_lt) <font color="ff0000"> --tag=CC </font> $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS)
...
</pre>


