---
layout: post
title: "iOS 音频设备开发"
date: 2015-02-05
comments: false
---
# iOS 音频设备开发
February 5, 2015

#### 请求麦克风权限
<pre>
AVAudioSession *audioSession = [AVAudioSession sharedInstance];
if ([audioSession respondsToSelector:@selector(requestRecordPermission:)]) {
        [audioSession requestRecordPermission:^(BOOL available) {
            //等待用户响应
        }];
}
</pre>

#### 录音
<pre>
//开始前必须激活AVAudioSession
AVAudioSession *audioSession = [AVAudioSession sharedInstance];
[audioSession setCategory:AVAudioSessionCategoryPlayAndRecord error:nil];
[audioSession setActive:YES error:nil];


//开始录音
- (void)onStartButtonPressed:(id)sender {
	//<font color="FF0000">注意此处文件的后缀名，不能未mp3、m4a、mp1、mp2、mp4、aac等，否则会导致无法录音，具体原因还不清楚</font>
    _path = [NSString stringWithFormat:@"%@/Documents/1.caf", NSHomeDirectory()];
    NSMutableDictionary* recordSetting = [[NSMutableDictionary alloc] init];
    
    // You can change the settings for the voice quality
    [recordSetting setValue :[NSNumber numberWithInt:kAudioFormatAppleIMA4] forKey:AVFormatIDKey];
    [recordSetting setValue:[NSNumber numberWithFloat:16000.0] forKey:AVSampleRateKey];
    [recordSetting setValue:[NSNumber numberWithInt: 1] forKey:AVNumberOfChannelsKey];
    [_audioRecorder stop];

    NSError* error;
    _audioRecorder = [[AVAudioRecorder alloc] initWithURL:[NSURL fileURLWithPath:_path] settings:recordSetting error:&error];
    if (![_audioRecorder prepareToRecord]) {
        NSLog(@"create failed");
    }
    _audioRecorder.delegate = self;
    [_audioRecorder record];
}

//结束录音
- (void)onStopButtonPressed:(id)sender {
    [_audioRecorder stop];
}
	
</pre>

目前支持的音频格式如下:
<pre>
enum
{
    kAudioFormatLinearPCM               = 'lpcm',
    kAudioFormatAC3                     = 'ac-3',
    kAudioFormat60958AC3                = 'cac3',
    kAudioFormatAppleIMA4               = 'ima4',
    kAudioFormatMPEG4AAC                = 'aac ',
    kAudioFormatMPEG4CELP               = 'celp',
    kAudioFormatMPEG4HVXC               = 'hvxc',
    kAudioFormatMPEG4TwinVQ             = 'twvq',
    kAudioFormatMACE3                   = 'MAC3',
    kAudioFormatMACE6                   = 'MAC6',
    kAudioFormatULaw                    = 'ulaw',
    kAudioFormatALaw                    = 'alaw',
    kAudioFormatQDesign                 = 'QDMC',
    kAudioFormatQDesign2                = 'QDM2',
    kAudioFormatQUALCOMM                = 'Qclp',
    kAudioFormatMPEGLayer1              = '.mp1',
    kAudioFormatMPEGLayer2              = '.mp2',
    kAudioFormatMPEGLayer3              = '.mp3',
    kAudioFormatTimeCode                = 'time',
    kAudioFormatMIDIStream              = 'midi',
    kAudioFormatParameterValueStream    = 'apvs',
    kAudioFormatAppleLossless           = 'alac',
    kAudioFormatMPEG4AAC_HE             = 'aach',
    kAudioFormatMPEG4AAC_LD             = 'aacl',
    kAudioFormatMPEG4AAC_ELD            = 'aace',
    kAudioFormatMPEG4AAC_ELD_SBR        = 'aacf',
    kAudioFormatMPEG4AAC_ELD_V2         = 'aacg',    
    kAudioFormatMPEG4AAC_HE_V2          = 'aacp',
    kAudioFormatMPEG4AAC_Spatial        = 'aacs',
    kAudioFormatAMR                     = 'samr',
    kAudioFormatAMR_WB                  = 'sawb',
    kAudioFormatAudible                 = 'AUDB',
    kAudioFormatiLBC                    = 'ilbc',
    kAudioFormatDVIIntelIMA             = 0x6D730011,
    kAudioFormatMicrosoftGSM            = 0x6D730031,
    kAudioFormatAES3                    = 'aes3'
};
</pre>


#### 所有声音设备类型(kAudioSessionProperty_AudioRouteDescription)
* 输入类型(kAudioSession_AudioRouteKey_Inputs)
	<pre>
	const CFStringRef kAudioSessionInputRoute_LineIn; //输入线
	const CFStringRef kAudioSessionInputRoute_BuiltInMic; //内置麦克风
	const CFStringRef kAudioSessionInputRoute_HeadsetMic; //头戴麦克风
	const CFStringRef kAudioSessionInputRoute_BluetoothHFP; //蓝牙耳机
	const CFStringRef kAudioSessionInputRoute_USBAudio; //USB音频
	</pre>
* 输出类型
	<pre>
	const CFStringRef kAudioSessionOutputRoute_LineOut;//输出线
	const CFStringRef kAudioSessionOutputRoute_Headphones;
	const CFStringRef kAudioSessionOutputRoute_BluetoothHFP;
	const CFStringRef kAudioSessionOutputRoute_BluetoothA2DP;
	const CFStringRef kAudioSessionOutputRoute_BuiltInReceiver;
	const CFStringRef kAudioSessionOutputRoute_BuiltInSpeaker;
	const CFStringRef kAudioSessionOutputRoute_USBAudio;
	const CFStringRef kAudioSessionOutputRoute_HDMI;
	const CFStringRef kAudioSessionOutputRoute_AirPlay;
	</pre>
	
#### 检测音频输入变动
<pre>
...
AudioSessionInitialize(NULL, NULL, NULL, NULL);
OSStatus lStatus = AudioSessionAddPropertyListener(kAudioSessionProperty_AudioRouteChange, audioRouteChangeListenerCallback, nil);
...

static void audioRouteChangeListenerCallback (void *inUserData, AudioSessionPropertyID inPropertyID, UInt32 inPropertyValueSize, const void *inPropertyValue ) {
    CFStringRef route;
    UInt32 size = sizeof(route);
    AudioSessionGetProperty(kAudioSessionProperty_AudioRoute, &size, &route);
    NSLog(@"route=%@", route);
}
</pre>