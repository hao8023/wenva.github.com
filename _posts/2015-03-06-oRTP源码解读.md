---
layout: post
title: "oRTP源码解读"
date: 2015-03-06
comments: false
---
# oRTP源码解读
March 6, 2015
### 背景
* 采样率 - 1s采样数目
* 帧 - 包含多个采样点，即一段采样时间内所有的采样点；帧时长=帧采样数*每个采样点时长
* 帧率 - 1s帧数
* RTP时间戳采用的单位：1/采样率；目的是更精确

### RTP的封装
* 结构[header+payload]
	<pre>
	0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |V=2|P|X|  CC   |M|     PT      |       sequence number         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           timestamp                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           synchronization source (SSRC) identifier            |
   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
   |            contributing source (CSRC) identifiers             |
   |                             ....                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   </pre>
	代码定义如下:
	<pre>
	typedef struct rtp_header
	{
	\#ifdef ORTP_BIGENDIAN
		uint16_t version:2;
		uint16_t padbit:1;
		uint16_t extbit:1;
		uint16_t cc:4;
		uint16_t markbit:1;
		uint16_t paytype:7;
	\#else
		uint16_t cc:4;
		uint16_t extbit:1;
		uint16_t padbit:1;
		uint16_t version:2;
		uint16_t paytype:7;
		uint16_t markbit:1;
	\#endif
		uint16_t seq_number;
		uint32_t timestamp;
		uint32_t ssrc;
		uint32_t csrc[16];
	} rtp_header_t;
	</pre>
* 扩展

### RTP流发送流程rtp_session_send_with_ts
* 获取一帧音频（或视频）数据组成payload
* 初始化rtp header
* 组装包: header + payload
* 设置时间戳、发送序列号
* socket发送
* ...下一帧发送...

### RTP流接收流程rtp_session_recv_with_ts


	
### RTCP的封装
* 主要功能
	* 服务质量的监视与反馈
	* 媒体间的同步
	* 多播组中成员的标识
* 特征
	* 参与者周期性发送
	* 利用UDP传输
* 类型

	|类型|缩写表示|用途|
	|:--|:--|:--|
	|200|SR(Sender Report)|发送端报告|
	|201|RR(Receiver Report)|接收端报告|
	|200|SDES(Source Description Items)|源点描述|
	|200|BYE|结束传输|
	|200|APP|特定应用|
	
	代码定义如下:
	<pre>
	typedef enum {
		RTCP_SR = 200,
		RTCP_RR = 201,
		RTCP_SDES = 202,
		RTCP_BYE = 203,
		RTCP_APP = 204,
		RTCP_RTPFB = 205,
		RTCP_PSFB = 206,
		RTCP_XR = 207
	} rtcp_type_t;
</pre>
* 结构

	<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|V=2|P|    RC   |   PT=SR=200   |             length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
RTCP结构由header+padding(s)，其中header格式如上，body根据类型而定

* V - 2bits 版本信息，rtp版本
* P - 1bit 填充位
* PT - 8bits RTCP类型，有SR、RR等
* length - 16bits 包含header+padding

	代码定义如下:
	<pre>
	typedef struct rtcp_common_header
	{
	\#ifdef ORTP_BIGENDIAN
		uint16_t version:2;
		uint16_t padbit:1;
		uint16_t rc:5;
		uint16_t packet_type:8;
	\#else
		uint16_t rc:5;
		uint16_t padbit:1;
		uint16_t version:2;
		uint16_t packet_type:8;
	\#endif
		uint16_t length:16;
	} rtcp_common_header_t;

	</pre>

###### BYE包
* -
	<pre>
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |V=2|P|    SC   |   PT=BYE=203  |             length            |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                           SSRC/CSRC                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      :                              ...                              :
      +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
(opt) |     length    |               reason for leaving            ...
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
* 第二个length - 8bits reason的长度，最大长度255